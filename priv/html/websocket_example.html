<!DOCTYPE html>
<html>

<head>
    <title>HashPay WebSocket Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        #messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }

        #message-form {
            display: flex;
            margin-bottom: 20px;
        }

        #message-input {
            flex-grow: 1;
            padding: 8px;
            margin-right: 10px;
        }

        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        .message {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        .timestamp {
            font-size: 0.8em;
            color: #999;
        }

        .system-message {
            color: #888;
            font-style: italic;
        }

        .user-event {
            color: #0066cc;
            font-style: italic;
        }

        .channel-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .channel-selector {
            display: flex;
            align-items: center;
        }

        .channel-selector select {
            margin-left: 10px;
            padding: 5px;
        }

        .user-id {
            font-weight: bold;
        }

        .online-users {
            margin-top: 20px;
        }

        .online-users h3 {
            margin-bottom: 5px;
        }

        .user-list {
            border: 1px solid #eee;
            padding: 10px;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>HashPay WebSocket Example</h1>

        <div class="channel-info">
            <div id="connection-status">Estado: Desconectado</div>
            <div class="channel-selector">
                Canal:
                <select id="channel-select">
                    <option value="lobby">Lobby</option>
                    <option value="payments">Payments</option>
                    <option value="support">Support</option>
                    <option value="custom">Custom</option>
                </select>
                <input type="text" id="custom-channel" placeholder="Nombre del canal"
                    style="display: none; margin-left: 10px; padding: 5px;" />
            </div>
        </div>

        <div id="messages"></div>

        <form id="message-form">
            <input type="text" id="message-input" placeholder="Escribe un mensaje..." />
            <button type="submit">Enviar</button>
        </form>

        <div class="online-users">
            <h3>Usuarios en este canal:</h3>
            <div id="user-list" class="user-list">No hay usuarios conectados</div>
        </div>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const connectionStatus = document.getElementById('connection-status');
        const channelSelect = document.getElementById('channel-select');
        const customChannelInput = document.getElementById('custom-channel');
        const userListContainer = document.getElementById('user-list');

        // Generar un ID de usuario aleatorio
        const userId = 'user_' + Math.random().toString(36).substr(2, 9);

        // Estado de la aplicación
        let currentChannel = 'lobby';
        let socket = null;
        let onlineUsers = new Set();

        // Manejar cambio de canal
        channelSelect.addEventListener('change', function () {
            const selectedValue = this.value;

            if (selectedValue === 'custom') {
                customChannelInput.style.display = 'inline-block';
                customChannelInput.focus();
            } else {
                customChannelInput.style.display = 'none';
                connectToChannel(selectedValue);
            }
        });

        customChannelInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const customChannel = this.value.trim();
                if (customChannel) {
                    connectToChannel(customChannel);
                }
            }
        });

        // Conectar al WebSocket con el canal especificado
        function connectToChannel(channel) {
            // Cerrar la conexión anterior si existe
            if (socket && socket.readyState !== WebSocket.CLOSED) {
                socket.close();
            }

            // Limpiar mensajes y usuarios
            messagesContainer.innerHTML = '';
            onlineUsers.clear();
            updateUserList();

            currentChannel = channel;
            addSystemMessage(`Conectando al canal: ${channel}...`);

            // Crear nueva conexión WebSocket
            socket = new WebSocket(`ws://${window.location.host}/ws?user_id=${userId}&channel=${channel}`);

            socket.onopen = () => {
                connectionStatus.textContent = `Estado: Conectado (ID: ${userId}, Canal: ${channel})`;
                connectionStatus.style.color = 'green';
                addSystemMessage(`Conectado al canal: ${channel}`);

                // Agregar este usuario a la lista
                onlineUsers.add(userId);
                updateUserList();
            };

            socket.onclose = () => {
                connectionStatus.textContent = 'Estado: Desconectado';
                connectionStatus.style.color = 'red';
                addSystemMessage('Desconectado del servidor');

                // Limpiar la lista de usuarios
                onlineUsers.clear();
                updateUserList();
            };

            socket.onerror = (error) => {
                console.error('Error en WebSocket:', error);
                addSystemMessage('Error en la conexión');
            };

            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    switch (data.type) {
                        case 'message_sent':
                            // Confirmación de mensaje enviado
                            break;

                        case 'channel_message':
                            // Mensaje recibido de otro usuario en el canal
                            addUserMessage(
                                data.message.user_id,
                                data.message.content,
                                data.message.timestamp
                            );
                            break;

                        case 'user_event':
                            // Evento de usuario (unión, salida, etc.)
                            handleUserEvent(data);
                            break;

                        case 'broadcast':
                            // Mensaje de broadcast
                            addSystemMessage(`Broadcast: ${data.message.content}`);
                            break;

                        case 'heartbeat':
                            // Mensaje de heartbeat (mantener conexión viva)
                            // No mostrar en el chat, solo registrar en consola
                            console.log(`Heartbeat recibido: ${data.timestamp}`);
                            // Responder al heartbeat para confirmar que el cliente está activo
                            if (socket && socket.readyState === WebSocket.OPEN) {
                                socket.send(JSON.stringify({
                                    type: 'heartbeat_ack',
                                    timestamp: new Date().toISOString()
                                }));
                            }
                            break;

                        default:
                            console.log('Mensaje desconocido:', data);
                    }
                } catch (e) {
                    console.error('Error al procesar mensaje:', e);
                    addSystemMessage('Error al procesar mensaje: ' + event.data);
                }
            };
        }

        // Manejar eventos de usuario
        function handleUserEvent(data) {
            const { user_id, event, timestamp } = data;

            switch (event) {
                case 'joined':
                    addUserEvent(`${user_id} se ha unido al canal`, timestamp);
                    onlineUsers.add(user_id);
                    break;

                case 'left':
                    addUserEvent(`${user_id} ha abandonado el canal`, timestamp);
                    onlineUsers.delete(user_id);
                    break;
            }

            updateUserList();
        }

        // Actualizar la lista de usuarios en línea
        function updateUserList() {
            if (onlineUsers.size === 0) {
                userListContainer.innerHTML = 'No hay usuarios conectados';
                return;
            }

            const userListHTML = Array.from(onlineUsers)
                .map(user => `<div class="user-item">${user}${user === userId ? ' (tú)' : ''}</div>`)
                .join('');

            userListContainer.innerHTML = userListHTML;
        }

        // Enviar mensaje
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message && socket && socket.readyState === WebSocket.OPEN) {
                socket.send(message);
                messageInput.value = '';
            }
        });

        // Agregar mensaje de usuario
        function addUserMessage(sender, text, timestamp = new Date().toISOString()) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';

            const date = new Date(timestamp);
            const formattedTime = date.toLocaleTimeString();

            const isCurrentUser = sender === userId;

            messageElement.innerHTML = `
            <strong>${sender}${isCurrentUser ? ' (tú)' : ''}:</strong> ${text}
            <div class="timestamp">${formattedTime}</div>
          `;

            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Agregar mensaje del sistema
        function addSystemMessage(text, timestamp = new Date().toISOString()) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message system-message';

            const date = new Date(timestamp);
            const formattedTime = date.toLocaleTimeString();

            messageElement.innerHTML = `
            <em>Sistema: ${text}</em>
            <div class="timestamp">${formattedTime}</div>
          `;

            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Agregar evento de usuario
        function addUserEvent(text, timestamp = new Date().toISOString()) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message user-event';

            const date = new Date(timestamp);
            const formattedTime = date.toLocaleTimeString();

            messageElement.innerHTML = `
            <em>${text}</em>
            <div class="timestamp">${formattedTime}</div>
          `;

            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Conectar al canal por defecto al cargar la página
        connectToChannel('lobby');
    </script>
</body>

</html>